name: Firebase Data Import

on:
  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³
  workflow_dispatch:
    inputs:
      description:
        description: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œã®èª¬æ˜'
        required: false
        default: 'æ‰‹å‹•å®Ÿè¡Œ'
  
  # data/firestoreé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches:
      - main
    paths:
      - 'data/firestore/**'
      - 'src/**'
      - 'pom.xml'

jobs:
  import-to-firestore:
    runs-on: ubuntu-latest
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Java 11ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    
    # GitHub Secretsã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
    - name: Create service account key file
      run: |
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > serviceAccountKey.json
        echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
    
    # Mavenã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Build with Maven
      run: |
        mvn clean install -DskipTests
        echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    # Firebaseã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    - name: Import data to Firestore
      run: |
        echo "ğŸš€ Firestoreã¸ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™..."
        mvn exec:java -Dexec.mainClass="com.example.firebase.BulkFirebaseImporter"
        echo "âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å®Ÿè¡Œå¾Œã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’å‰Šé™¤
    - name: Clean up service account key
      if: always()
      run: |
        rm -f serviceAccountKey.json
        echo "ğŸ”’ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
